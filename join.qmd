---
title: "Join the Community"
format: html
execute:
  shiny: true
page-layout: full
---

We are excited to welcome new members to the Kenyan Community in Scotland!  
Please fill in your details below to join us.

```{r}
#| echo: false
#| warning: false
#| message: false

library(shiny)
library(blastula)

fluidPage(
  wellPanel(
    textInput("name", "Full Name:", placeholder = "Enter Your Full Name"),
    textInput("email", "Email Address:", placeholder = "Enter Your Email Address"),
    textInput("mobile", "Mobile Number:", placeholder = "Enter Your Mobile Number (e.g., +44 7522 XXX XXX)"),
    selectInput("interest", "Area of Interest:",
                choices = c("", "Networking", "Volunteering", "Events", "Sponsorship")),
    actionButton("submit", "Join Now", class = "btn btn-primary btn-lg"),
    textOutput("confirmation")
  )
)

observeEvent(input$submit, {
  
  # Basic validation
  if (input$name == "" || input$email == "" || input$mobile == "") {
    showModal(modalDialog(
      title = "Incomplete Submission",
      "Please fill in all the fields before submitting.",
      easyClose = TRUE
    ))
  } else {
    
    # Save the submission to CSV
    new_entry <- data.frame(
      Name = input$name,
      Email = input$email,
      Mobile = input$mobile,
      Interest = input$interest,
      Timestamp = Sys.time()
    )
    
    # If file doesn't exist, create it with headers
    if (!file.exists("community_signups.csv")) {
      write.csv(new_entry, "community_signups.csv", row.names = FALSE)
    } else {
      # Otherwise append without headers
      write.table(new_entry, "community_signups.csv",
                  sep = ",", append = TRUE,
                  col.names = FALSE, row.names = FALSE)
    }
    
    # Compose and send Thank You email
    thank_you_email <- compose_email(
      body = md(glue::glue(
        "
        <div style='text-align: center;'>
          <h1 style='color: green;'>Welcome, {input$name}! ðŸ‡°ðŸ‡ª</h1>
          <h3 style='color: red;'>You've successfully joined the Kenyan Community in Scotland!</h3>
          <p style='font-size: 16px; color: black;'>
            We are thrilled to have you as part of our vibrant, supportive, and inspiring community.<br><br>
            <strong>Area of Interest:</strong> {input$interest}<br><br>
            Stay tuned for exciting updates, events, and opportunities to engage with the community!<br><br>
            Warm regards,<br>
            <strong>Kenyan Community in Scotland Team</strong>
          </p>
          <br>
          <a href='https://kenyancommunityinscotland.uk/' 
             style='background-color: green; color: white; padding: 10px 20px; text-decoration: none; font-size: 18px; border-radius: 5px;'>
            Visit Our Website
          </a>
        </div>
        "
      ))
    )
    
    smtp_send(
      email = thank_you_email,
      from = "kenyancommunityinscotland@gmail.com",
      to = input$email,
      subject = "Welcome to the Kenyan Community in Scotland!",
      credentials = creds_key("gmail")
    )
    
    showModal(modalDialog(
      title = "Thank you!",
      paste("Welcome to the Kenyan Community in Scotland,", input$name, "!"),
      easyClose = TRUE
    ))
  }
})
```